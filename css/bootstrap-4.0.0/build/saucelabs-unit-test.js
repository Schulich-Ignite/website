/*!
 * Script to run our Sauce Labs tests.
 * Copyright 2017-2018 The Bootstrap Authors
 * Copyright 2017-2018 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 */
"use strict";const path=require("path"),JSUnitSaucelabs=require("jsunitsaucelabs"),jsUnitSaucelabs=new JSUnitSaucelabs({username:process.env.SAUCE_USERNAME,password:process.env.SAUCE_ACCESS_KEY,build:process.env.TRAVIS_JOB_ID}),testURL="http://localhost:3000/js/tests/index.html?hidepassed",browsersFile=require(path.resolve(__dirname,"./sauce_browsers.json"));let jobsDone=0,jobsSucceeded=0;const waitingCallback=(e,s,t)=>{if(e&&(console.error(e),process.exit(1)),void 0!==s)if(s.completed){const e=s["js tests"][0];let t=!1,o=!1;if(null!==e.result&&("string"==typeof e.result&&"Test exceeded maximum duration"===e.result?o=e.result:t=e.result.total===e.result.passed),console.log("Tested "+testURL),console.log("Platform: "+e.platform.join(", ")),console.log("Passed: "+t.toString()),console.log(`URL: ${e.url}\n`),o&&console.error(o),t&&jobsSucceeded++,jobsDone++,jobsDone===browsersFile.length-1){if(jsUnitSaucelabs.stop(),jobsDone>jobsSucceeded)throw new Error(`Some test(s) failed (${jobsDone-jobsSucceeded})`);console.log("All tests passed"),process.exit(0)}}else setTimeout(()=>{jsUnitSaucelabs.getStatus(t,(e,s)=>{waitingCallback(e,s,t)})},2e3)};jsUnitSaucelabs.on("tunnelCreated",()=>{browsersFile.forEach(e=>{const s=[void 0===e.platform?e.platformName:e.platform,e.browserName,e.version];jsUnitSaucelabs.start([s],testURL,"qunit",(e,s)=>{if(void 0!==s){const e=s["js tests"];if(!e||0===e.length)throw new Error("Error starting tests through Sauce Labs API");e.forEach(e=>{jsUnitSaucelabs.getStatus(e,(s,t)=>{waitingCallback(s,t,e)})})}else console.error(e)})})}),jsUnitSaucelabs.initTunnel();